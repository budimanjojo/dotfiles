-- Diagnostic looks
vim.diagnostic.config {
  virtual_text = false,
  update_in_insert = true,
  float = {
    source = 'if_many'
  }
}

-- Signcolumn symbols
local signs = { Error = ' ', Warn = ' ', Hint = ' ', Info = ' ' }
for type, icon in pairs(signs) do
  local hl = 'DiagnosticSign' .. type
  vim.fn.sign_define(hl, { text = icon, texthl = hl, numhl = hl })
end

-- Show diagnostics on hover
vim.o.updatetime = 150
vim.cmd([[autocmd CursorHold * lua vim.diagnostic.open_float(nil, { focusable = false })]])

-- LSP Server Setup Goes Below
require('nvim-lsp-installer').setup {
  automatic_installation = true,
  ui = {
    check_outdated_servers_on_open = true
  }
}

local lspconfig = require('lspconfig')
local capabilities = require('cmp_nvim_lsp').update_capabilities(vim.lsp.protocol.make_client_capabilities())
local on_attach = function(_, bufnr)
  require 'lsp_signature'.on_attach()
  local keymap = vim.keymap
  local opts = { buffer = bufnr }

  keymap.set('n', 'rn', vim.lsp.buf.rename, { unpack(opts), desc = "Do LSP rename action" })
  keymap.set('n', 'gd', vim.lsp.buf.definition, { unpack(opts), desc = "Do LSP get definition action" })
  keymap.set('n', 'gD', vim.lsp.buf.declaration, { unpack(opts), desc = "Do LSP get declaration action" })
  keymap.set('n', 'gh', function() return require('utils').fix_buf_hover() end, { unpack(opts), desc = "Do LSP hover action" })
  keymap.set('n', 'gr', vim.lsp.buf.references, { unpack(opts), desc = "Do LSP get references action" })
  keymap.set('n', 'gi', vim.lsp.buf.implementation, { unpack(opts), desc = "Do LSP get implementation action"})
end

-- ansiblels
lspconfig.ansiblels.setup {
  capabilities = capabilities,
  on_attach = on_attach,
}

-- bashls
lspconfig.bashls.setup {
  capabilities = capabilities,
  on_attach = on_attach,
}

-- cssls
lspconfig.cssls.setup {
  capabilities = capabilities,
  on_attach = on_attach,
}

-- dockerls
lspconfig.dockerls.setup {
  capabilities = capabilities,
  on_attach = on_attach,
}

{{ if not .headless -}}
-- gopls
lspconfig.gopls.setup {
  capabilities = capabilities,
  on_attach = on_attach,
}
{{ end -}}

-- javascript
lspconfig.tsserver.setup {
  capabilities = capabilities,
  on_attach = on_attach,
}

-- jsonls
lspconfig.jsonls.setup {
  capabilities = capabilities,
  on_attach = on_attach,
  settings = {
    json = {
      schemas = require('schemastore').json.schemas(),
    }
  }
}

-- pyright
lspconfig.pyright.setup {
  capabilities = capabilities,
  on_attach = on_attach,
}

-- sumneko_lua
lspconfig.sumneko_lua.setup {
  capabilities = capabilities,
  on_attach = on_attach,
  settings = {
    Lua = {
      runtime = {
        version = 'LuaJIT',
      },
      diagnostics = {
        globals = { 'vim' },
      },
      workspace = {
        library = vim.api.nvim_get_runtime_file('', true),
        preloadFileSize = 200,
      },
      telemetry = {
        enable = false,
      },
    }
  }
}

-- yamlls
lspconfig.yamlls.setup {
  capabilities = capabilities,
  on_attach = on_attach,
  settings = {
    yaml = {
      customTags = {
        '!include_dir_list',
        '!include_dir_named',
        '!include_dir_merge_list',
        '!include_dir_merge_named',
        '!secret',
        '!env_var',
      },
      schemas = {
        kubernetes = {
          '01-namespace.yaml',
          'deployment.yaml',
          'daemonset.yaml',
          'statefulset.yaml',
          'service.yaml',
          'pv.yaml',
          'pvc.yaml',
          'configmap.yaml',
          'secret.yaml',
          'rbac.yaml',
          'crd.yaml',
          'storageclass.yaml',
          'cronjob.yaml'
        },
        ['https://raw.githubusercontent.com/docker/compose/master/compose/config/compose_spec.json'] = {
          'docker-compose.yml',
          'docker-compose.yaml'
        },
        ['https://json.schemastore.org/github-workflow'] = {
          '.github/workflows/**.yml',
          '.github/workflows/**.yaml'
        },
        ['https://json.schemastore.org/github-actions'] = {
          'action.yml',
          'action.yaml'
        },
        ['https://json.schemastore.org/gitlab-ci'] = '.gitlab-ci.yml',
        ['https://json.schemastore.org/kustomization'] = {
          'kustomization.yml',
          'kustomization.yaml'
        },
        ['https://json.schemastore.org/pre-commit-config'] = {
          '.pre-commit-config.yml',
          '.pre-commit-config.yaml',
        }
      }
    }
  }
}
